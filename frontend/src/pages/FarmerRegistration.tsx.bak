// src/pages/FarmerRegistration.tsx
import React, { JSX, useState } from "react";
import { useNavigate } from "react-router-dom";
import farmerService from "@/services/farmer.service";

type FormState = {
  firstName: string;
  lastName: string;
  gender: string;
  dob: string;
  phone: string;
  email: string;
  province: string;
  district: string;
  village: string;
  landSize: string;
  primaryCrop: string;
  notes: string;
};

const provinces = [
  "Lusaka",
  "Copperbelt",
  "Central",
  "Eastern",
  "Luapula",
  "Muchinga",
  "Northern",
  "North-Western",
  "Southern",
  "Western",
];

const districtsByProvince: Record<string, string[]> = {
  Lusaka: ["Lusaka District", "Chongwe", "Kafue"],
  Copperbelt: ["Ndola", "Kitwe", "Chingola"],
  Central: ["Kabwe", "Mkushi"],
  Eastern: ["Chipata", "Lundazi"],
  Southern: ["Livingstone", "Choma"],
  // fallback will handle provinces not listed
};

const genders = ["Male", "Female", "Other"];
const cropOptions = ["Maize", "Soybean", "Groundnut", "Cassava", "Rice", "Cotton"];

export default function FarmerRegistration(): JSX.Element {
  const navigate = useNavigate();
  const [form, setForm] = useState<FormState>({
    firstName: "",
    lastName: "",
    gender: "",
    dob: "",
    phone: "",
    email: "",
    province: "",
    district: "",
    village: "",
    landSize: "",
    primaryCrop: "",
    notes: "",
  });

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const handleChange = <K extends keyof FormState>(key: K, value: FormState[K]) =>
    setForm((p) => ({ ...p, [key]: value }));

  const validate = (): string | null => {
    if (!form.firstName.trim()) return "First name is required";
    if (!form.lastName.trim()) return "Last name is required";
    if (!form.phone.trim()) return "Phone is required (include country code, e.g. +260...)";
    if (!form.province) return "Province is required";
    if (!form.district) return "District is required";
    // Example phone format check: +260...
    if (!/^\+\d{6,15}$/.test(form.phone.trim())) {
      return "Phone must include country code and digits, e.g. +260971234567";
    }
    return null;
  };

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setSuccess(null);

    const vErr = validate();
    if (vErr) {
      setError(vErr);
      return;
    }

    setLoading(true);
    try {
      const payload = {
        personal_info: {
          first_name: form.firstName.trim(),
          last_name: form.lastName.trim(),
          gender: form.gender || undefined,
          dob: form.dob || undefined,
          phone_primary: form.phone.trim(),
          email: form.email?.trim() || undefined,
        },
        address: {
          province: form.province,
          district: form.district,
          village: form.village || undefined,
        },
        farm: {
          land_size: form.landSize || undefined,
          primary_crop: form.primaryCrop || undefined,
        },
        notes: form.notes || undefined,
      };

      // Call your existing service (keeps backend integration)
      const res = await farmerService.create(payload);
      setSuccess("Farmer created — ID: " + (res?.farmer_id || "unknown"));
      // clear or navigate after short delay:
      setTimeout(() => navigate("/farmers/"), 900);
    } catch (err: any) {
      console.error("Create farmer failed:", err);
      const msg =
        err?.response?.data?.detail ||
        (typeof err === "string" ? err : "Failed to create farmer");
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  const currentDistricts = form.province ? districtsByProvince[form.province] ?? [] : [];

  return (
    <div style={{ minHeight: "100vh", background: "#f3f4f6", padding: 20 }}>
      <div
        style={{
          maxWidth: 980,
          margin: "0 auto",
          display: "grid",
          gridTemplateColumns: "1fr 380px",
          gap: 24,
        }}
      >
        {/* Left — Form */}
        <div style={{ background: "#fff", padding: 24, borderRadius: 8, boxShadow: "0 6px 20px rgba(0,0,0,0.04)" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <h2 style={{ margin: 0 }}>Register Farmer</h2>
            <button
              onClick={() => navigate("/farmers/")}
              style={{
                border: "1px solid #e5e7eb",
                background: "#fff",
                padding: "8px 12px",
                borderRadius: 6,
                cursor: "pointer",
              }}
            >
              ← Back to list
            </button>
          </div>

          {error && (
            <div style={{ background: "#fdecea", color: "#b91c1c", padding: 12, borderRadius: 6, marginBottom: 12 }}>
              {error}
            </div>
          )}

          {success && (
            <div style={{ background: "#ecfdf5", color: "#065f46", padding: 12, borderRadius: 6, marginBottom: 12 }}>
              {success}
            </div>
          )}

          <form onSubmit={onSubmit}>
            <section style={{ marginBottom: 18 }}>
              <h4 style={{ margin: "6px 0 12px", color: "#374151" }}>Personal Information</h4>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>First name *</div>
                  <input
                    value={form.firstName}
                    onChange={(e) => handleChange("firstName", e.target.value)}
                    placeholder="John"
                    style={inputStyle}
                  />
                </label>

                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Last name *</div>
                  <input
                    value={form.lastName}
                    onChange={(e) => handleChange("lastName", e.target.value)}
                    placeholder="Doe"
                    style={inputStyle}
                  />
                </label>

                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Gender</div>
                  <select value={form.gender} onChange={(e) => handleChange("gender", e.target.value)} style={inputStyle}>
                    <option value="">Select gender</option>
                    {genders.map((g) => (
                      <option key={g} value={g}>
                        {g}
                      </option>
                    ))}
                  </select>
                </label>

                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Date of birth</div>
                  <input type="date" value={form.dob} onChange={(e) => handleChange("dob", e.target.value)} style={inputStyle} />
                </label>

                <label style={{ display: "block", gridColumn: "1 / 3" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Phone *</div>
                  <input
                    placeholder="+260971234567"
                    value={form.phone}
                    onChange={(e) => handleChange("phone", e.target.value)}
                    style={inputStyle}
                  />
                </label>

                <label style={{ display: "block", gridColumn: "1 / 3" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Email</div>
                  <input value={form.email} onChange={(e) => handleChange("email", e.target.value)} placeholder="you@example.com" style={inputStyle} />
                </label>
              </div>
            </section>

            <section style={{ marginBottom: 18 }}>
              <h4 style={{ margin: "6px 0 12px", color: "#374151" }}>Address</h4>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Province *</div>
                  <select
                    value={form.province}
                    onChange={(e) => {
                      handleChange("province", e.target.value);
                      // reset district when province changes
                      handleChange("district", "");
                    }}
                    style={inputStyle}
                  >
                    <option value="">Select province</option>
                    {provinces.map((p) => (
                      <option key={p} value={p}>
                        {p}
                      </option>
                    ))}
                  </select>
                </label>

                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>District *</div>
                  <select value={form.district} onChange={(e) => handleChange("district", e.target.value)} style={inputStyle}>
                    <option value="">Select district</option>
                    {currentDistricts.length > 0
                      ? currentDistricts.map((d) => (
                          <option key={d} value={d}>
                            {d}
                          </option>
                        ))
                      : // if no district list for chosen province, show a small set or allow manual typing
                        form.province
                      ? <option value="Other">Other</option>
                      : null}
                  </select>
                </label>

                <label style={{ display: "block", gridColumn: "1 / 3" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Village / Location</div>
                  <input value={form.village} onChange={(e) => handleChange("village", e.target.value)} style={inputStyle} />
                </label>
              </div>
            </section>

            <section style={{ marginBottom: 18 }}>
              <h4 style={{ margin: "6px 0 12px", color: "#374151" }}>Farm Details</h4>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Land size (ha)</div>
                  <input placeholder="e.g. 0.5" value={form.landSize} onChange={(e) => handleChange("landSize", e.target.value)} style={inputStyle} />
                </label>

                <label style={{ display: "block" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Primary crop</div>
                  <select value={form.primaryCrop} onChange={(e) => handleChange("primaryCrop", e.target.value)} style={inputStyle}>
                    <option value="">Select primary crop</option>
                    {cropOptions.map((c) => (
                      <option key={c} value={c}>
                        {c}
                      </option>
                    ))}
                  </select>
                </label>

                <label style={{ display: "block", gridColumn: "1 / 3" }}>
                  <div style={{ fontWeight: 700, marginBottom: 6 }}>Notes</div>
                  <textarea value={form.notes} onChange={(e) => handleChange("notes", e.target.value)} rows={3} style={{ ...inputStyle, resize: "vertical" }} />
                </label>
              </div>
            </section>

            <div style={{ display: "flex", gap: 12, marginTop: 6 }}>
              <button
                type="submit"
                disabled={loading}
                style={{
                  flex: 1,
                  padding: "12px 16px",
                  borderRadius: 6,
                  border: "none",
                  background: loading ? "#94A3B8" : "#059669",
                  color: "#fff",
                  fontWeight: 700,
                  cursor: loading ? "not-allowed" : "pointer",
                }}
              >
                {loading ? "⏳ Creating..." : "✅ Create farmer"}
              </button>

              <button
                type="button"
                onClick={() => navigate("/farmers/")}
                style={{
                  flex: 1,
                  padding: "12px 16px",
                  borderRadius: 6,
                  border: "1px solid #e5e7eb",
                  background: "#fff",
                  color: "#111827",
                  fontWeight: 700,
                  cursor: "pointer",
                }}
              >
                Cancel
              </button>
            </div>
          </form>
        </div>

        {/* Right — Quick info / preview */}
        <aside style={{ background: "#fff", padding: 20, borderRadius: 8, height: "fit-content", boxShadow: "0 6px 20px rgba(0,0,0,0.04)" }}>
          <h3 style={{ marginTop: 0 }}>Preview & Tips</h3>
          <div style={{ color: "#6b7280", marginBottom: 12 }}>
            Fill farmer's primary contact and address. Phone must include country code (+260...). After creation, the system will assign a Farmer ID and registration status.
          </div>

          <div style={{ marginTop: 8 }}>
            <strong>Current values</strong>
            <ul style={{ paddingLeft: 18, marginTop: 8 }}>
              <li><strong>Name:</strong> {form.firstName || "-"} {form.lastName || ""}</li>
              <li><strong>Phone:</strong> {form.phone || "-"}</li>
              <li><strong>Province:</strong> {form.province || "-"}</li>
              <li><strong>District:</strong> {form.district || "-"}</li>
              <li><strong>Primary crop:</strong> {form.primaryCrop || "-"}</li>
            </ul>
          </div>

          <div style={{ marginTop: 16 }}>
            <button
              onClick={() => {
                // quick-fill for testing convenience
                setForm({
                  firstName: "Test",
                  lastName: "Farmer",
                  gender: "Male",
                  dob: "",
                  phone: "+260971234567",
                  email: "",
                  province: "Lusaka",
                  district: "Kafue",
                  village: "Test Village",
                  landSize: "1.2",
                  primaryCrop: "Maize",
                  notes: "",
                });
              }}
              style={{
                width: "100%",
                padding: "10px 12px",
                borderRadius: 6,
                border: "none",
                background: "#2563EB",
                color: "#fff",
                fontWeight: 700,
                cursor: "pointer",
              }}
            >
              Quick-fill sample
            </button>
          </div>
        </aside>
      </div>
    </div>
  );
}

// small shared input style
const inputStyle: React.CSSProperties = {
  width: "100%",
  padding: "10px 12px",
  borderRadius: 6,
  border: "1px solid #e5e7eb",
  boxSizing: "border-box",
  outline: "none",
  fontSize: 14,
};
